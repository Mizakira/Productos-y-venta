import { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithCustomToken, onAuthStateChanged, signInAnonymously } from 'firebase/auth';
import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, doc, deleteDoc, query } from 'firebase/firestore';

// Tailwind CSS is assumed to be available
// Lucid icons for UI, assumed to be available
const FileTextIcon = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-file-text"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>
);
const CpuIcon = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-cpu"><rect width="16" height="16" x="4" y="4" rx="2"/><rect width="6" height="6" x="9" y="9" rx="1"/><path d="M15 2v2"/><path d="M15 20v2"/><path d="M2 15h2"/><path d="M2 9h2"/><path d="M20 15h2"/><path d="M20 9h2"/><path d="M9 2v2"/><path d="M9 20v2"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="M2 12h2"/><path d="M20 12h2"/></svg>
);
const PlusIcon = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucude-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
);
const RepeatIcon = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-repeat"><path d="m17 2 4 4-4 4"/><path d="M3 11v-1a4 4 0 0 1 4-4h14"/><path d="m7 22-4-4 4-4"/><path d="M21 13v1a4 4 0 0 1-4 4H3"/></svg>
);
const UserIcon = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-user"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
);
const Trash2Icon = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
);
const SettingsIcon = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-settings"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.78 1.46a2 2 0 0 0 .73 2.73l.15.08a2 2 0 0 1 1 1.74v.18a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.78-1.46a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
);
const CheckCircleIcon = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-check-circle"><path d="M22 11.08V12a10 10 0 1 1-5.93-8.72"/><path d="M9 11l3 3L22 4"/></svg>
);
const AlertCircleIcon = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-alert-circle"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>
);
const XCircleIcon = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-x-circle"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>
);
const ArrowUpCircleIcon = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-arrow-up-circle"><circle cx="12" cy="12" r="10"/><path d="m8 12 4-4 4 4"/><path d="M12 16V8"/></svg>
);
const DollarSignIcon = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-dollar-sign"><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
);
const GaugeIcon = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-gauge"><path d="m12 14-6 6"/><path d="m17.5 17.5 3.5 3.5"/><path d="M13 18a6 6 0 1 1-6-6"/><path d="M15 9.5a2.5 2.5 0 0 1-5 0v-2a2.5 2.5 0 0 1 5 0z"/></svg>
);
const SearchIcon = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-search"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
);
const CompareArrowsIcon = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-compare-arrows"><path d="M10 12h14a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2h-14a2 2 0 0 1-2-2v-6a2 2 0 0 1 2-2zm0 14v-6a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2h-14a2 2 0 0 1-2-2z"/></svg>
);
const HeadphonesIcon = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-headphones"><path d="M3 11a7 7 0 1 1 14 0v1a10 10 0 0 1-17 0V11a3 3 0 0 1 3-3h12a3 3 0 0 1 3 3v1a10 10 0 0 1-17 0V11a7 7 0 0 1 7-7h1"/><path d="M12 4v2"/><path d="M12 2v2"/><path d="M12 20v2"/></svg>
);
const MonitorIcon = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-monitor"><rect width="20" height="15" x="2" y="3" rx="2"/><path d="M12 18v4"/><path d="M8 22h8"/></svg>
);


// Data for component tiers (for quick local lookups)
const tierData = {
  cpu: {
    "gama de entrada": ["i3", "ryzen 3", "3200g"],
    "gama media": ["i5", "ryzen 5", "5600g"],
    "gama media-alta": ["i7", "ryzen 7"],
    "gama alta": ["i9", "ryzen 9"],
  },
  gpu: {
    "gama de entrada": ["gtx 1650", "rtx 3050", "rx 6500"],
    "gama media": ["rtx 4060", "rx 7600", "rtx 3060"],
    "gama media-alta": ["rtx 4070", "rx 7700", "rtx 3070"],
    "gama alta": ["rtx 4090", "rx 7900 xtx", "rtx 3080"],
  },
  monitor: {
    "gama de entrada": ["monitor 22", "monitor 24", "monitor 1080p"],
    "gama media": ["monitor 27", "monitor 144hz", "monitor qhd"],
    "gama alta": ["monitor 4k", "monitor ultrawide", "monitor oled"],
  }
};

/**
 * Determines the performance tier of a component based on its name and type.
 * @param {string} componentName The name of the component.
 * @param {string} componentType The type of the component ('cpu', 'gpu', 'monitor').
 * @returns {string} The tier of the component.
 */
const getTier = (componentName, componentType) => {
  const nameLower = componentName.toLowerCase();
  if (!tierData[componentType]) return "desconocida";
  for (const tier in tierData[componentType]) {
    for (const keyword of tierData[componentType][tier]) {
      if (nameLower.includes(keyword)) {
        return tier;
      }
    }
  }
  return "desconocida";
};

// Main React component for the application
function App() {
  const [componentName, setComponentName] = useState("");
  const [componentInfo, setComponentInfo] = useState(null);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState("");
  const [quotes, setQuotes] = useState([]);
  const [isSaving, setIsSaving] = useState(false);
  const [saveMessage, setSaveMessage] = useState("");
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [userId, setUserId] = useState(null);
  const [searchTerm, setSearchTerm] = useState("");
  const [sortBy, setSortBy] = useState("dateDesc"); // New state for sorting

  // State for multi-component build
  const [currentBuild, setCurrentBuild] = useState([{ name: '', type: 'cpu' }]);
  const [buildAnalysisResult, setBuildAnalysisResult] = useState(null);
  const [isLoadingBuild, setIsLoadingBuild] = useState(false);
  const [buildError, setBuildError] = useState("");

  // New states for component comparison
  const [componentA, setComponentA] = useState("");
  const [componentB, setComponentB] = useState("");
  const [comparisonResult, setComparisonResult] = useState(null);
  const [isLoadingComparison, setIsLoadingComparison] = useState(false);
  const [comparisonError, setComparisonError] = useState("");
  const [isGeneralAnalysis, setIsGeneralAnalysis] = useState(false);


  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
  const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

  useEffect(() => {
    if (Object.keys(firebaseConfig).length > 0) {
      const app = initializeApp(firebaseConfig);
      const firestore = getFirestore(app);
      const authInstance = getAuth(app);
      setDb(firestore);
      setAuth(authInstance);

      onAuthStateChanged(authInstance, async (user) => {
        if (user) {
          setUserId(user.uid);
        } else {
          try {
            if (initialAuthToken) {
              await signInWithCustomToken(authInstance, initialAuthToken);
            } else {
              await signInAnonymously(authInstance);
            }
          } catch (e) {
            console.error("Error al iniciar sesión:", e);
          }
        }
      });
    }
  }, [firebaseConfig, initialAuthToken]);

  useEffect(() => {
    if (db && userId) {
      const quotesCollectionPath = `/artifacts/${appId}/users/${userId}/quotes`;
      const q = query(collection(db, quotesCollectionPath));
      const unsubscribe = onSnapshot(q, (snapshot) => {
        const fetchedQuotes = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data(),
        }));
        setQuotes(fetchedQuotes);
      });

      return () => unsubscribe();
    }
  }, [db, userId, appId]);

  const fetchWithRetry = async (url, options, retries = 3, delay = 1000) => {
    for (let i = 0; i < retries; i++) {
      try {
        const response = await fetch(url, options);
        if (response.ok) {
          return response;
        } else {
          console.error(`Fetch attempt ${i + 1} failed with status: ${response.status} ${response.statusText}`);
          if (i < retries - 1) {
            await new Promise(resolve => setTimeout(resolve, delay));
            delay *= 2;
          }
        }
      } catch (error) {
        console.error(`Fetch attempt ${i + 1} failed with error:`, error);
        if (i < retries - 1) {
            await new Promise(resolve => setTimeout(resolve, delay));
            delay *= 2;
        } else {
            throw error;
        }
      }
    }
    throw new Error('All fetch retries failed.');
  };

  const handleAnalyze = async () => {
    setIsLoading(true);
    setError("");
    setComponentInfo(null);
    setBuildAnalysisResult(null);
    setComparisonResult(null);
    setIsGeneralAnalysis(false);

    let componentType = null;
    const componentNameLower = componentName.toLowerCase();
    
    // Determine a basic component category for fallbacks
    if (componentNameLower.includes("rtx") || componentNameLower.includes("gtx") || componentNameLower.includes("rx")) {
        componentType = "gpu";
    } else if (componentNameLower.includes("ryzen") || componentNameLower.includes("i3") || componentNameLower.includes("i5") || componentNameLower.includes("i7") || componentNameLower.includes("i9")) {
        componentType = "cpu";
    } else if (componentNameLower.includes("monitor")) {
        componentType = "monitor";
    } else if (componentNameLower.includes("auricular") || componentNameLower.includes("audifono")) {
        componentType = "auricular";
    }

    if (!componentType) {
      setError("No se reconoce el tipo de componente. Intenta con un procesador, tarjeta gráfica, monitor o auricular.");
      setIsLoading(false);
      return;
    }

    const analyzeSpecificComponent = async () => {
      try {
        const prompt = `Analiza el componente de computadora llamado "${componentName}". Proporciona un análisis en formato JSON. El objeto JSON debe tener una clave 'summary' que es un arreglo de objetos (cada objeto con 'heading' y 'points'), una clave 'recommendations' que es un arreglo de objetos (cada objeto con 'component' y 'model', por ejemplo, 'GPU' con un modelo recomendado que sea compatible y del mismo nivel de gama), y una clave 'releaseYear' que es un string con el año de lanzamiento. Si el componente no existe, devuelve un objeto JSON con la clave 'error' y un mensaje descriptivo.`;
        const payload = {
            contents: [{ role: "user", parts: [{ text: prompt }] }],
            generationConfig: {
                responseMimeType: "application/json",
                responseSchema: {
                    type: "OBJECT",
                    properties: {
                        summary: { type: "ARRAY", items: { type: "OBJECT", properties: { heading: { type: "STRING" }, points: { type: "ARRAY", items: { type: "STRING" } } } } },
                        recommendations: { type: "ARRAY", items: { type: "OBJECT", properties: { component: { type: "STRING" }, model: { type: "STRING" } } } },
                        releaseYear: { type: "STRING" },
                        error: { type: "STRING" }
                    }
                }
            }
        };
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        const response = await fetchWithRetry(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const result = await response.json();
        const generatedJson = result?.candidates?.[0]?.content?.parts?.[0]?.text;
        
        if (!generatedJson) {
          return { error: "Respuesta de API vacía o con formato inesperado." };
        }

        const parsedData = JSON.parse(generatedJson);
        return parsedData;
      } catch (err) {
        console.error(err);
        return { error: "Ocurrió un error de conexión." };
      }
    };

    const analyzeGeneralComponent = async () => {
      try {
        const prompt = `Proporciona una guía de compra y análisis general para el siguiente tipo de producto: ${componentType}. El análisis debe estar en formato JSON con una clave 'summary' que es un arreglo de objetos (cada objeto con 'heading' y 'points') y una clave 'recommendations' que es un arreglo de objetos (cada objeto con 'component' y 'model', por ejemplo, 'GPU' con un modelo recomendado que sea compatible y del mismo nivel de gama). Si el tipo de componente no existe, devuelve un objeto JSON con la clave 'error' y un mensaje descriptivo.`;
        const payload = {
            contents: [{ role: "user", parts: [{ text: prompt }] }],
            generationConfig: {
                responseMimeType: "application/json",
                responseSchema: {
                    type: "OBJECT",
                    properties: {
                        summary: { type: "ARRAY", items: { type: "OBJECT", properties: { heading: { type: "STRING" }, points: { type: "ARRAY", items: { type: "STRING" } } } } },
                        recommendations: { type: "ARRAY", items: { type: "OBJECT", properties: { component: { type: "STRING" }, model: { type: "STRING" } } } },
                        error: { type: "STRING" }
                    }
                }
            }
        };
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        const response = await fetchWithRetry(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const result = await response.json();
        const generatedJson = result?.candidates?.[0]?.content?.parts?.[0]?.text;
        
        if (!generatedJson) {
          return { error: "Respuesta de API vacía o con formato inesperado." };
        }
        const parsedData = JSON.parse(generatedJson);
        return parsedData;
      } catch (err) {
        console.error(err);
        return { error: "Ocurrió un error de conexión." };
      }
    };

    // First, try to get specific component info
    let analysisData = await analyzeSpecificComponent();
    
    // If specific analysis fails, perform a general analysis instead
    if (analysisData.error) {
        setError("El componente específico no está en nuestra base de datos. A continuación se muestra un análisis general para este tipo de producto.");
        analysisData = await analyzeGeneralComponent();
        setIsGeneralAnalysis(true);
    } else {
        // Clear any previous error message if the specific analysis succeeded
        setError("");
        setIsGeneralAnalysis(false);
    }

    if (analysisData.error) {
        setError(analysisData.error);
        setIsLoading(false);
        return;
    }

    const gama = getTier(componentName, componentType);
    const releaseYear = analysisData.releaseYear || "Desconocido";

    setComponentInfo({
      gama,
      summary: analysisData.summary || [],
      recommendations: analysisData.recommendations || [],
      releaseYear: releaseYear
    });

    setIsLoading(false);
  };

  const handleSaveQuote = async (analysisData, type) => {
    if (!db || !userId) {
      setSaveMessage('No se puede guardar la cotización. Analiza un componente primero.');
      return;
    }
    setIsSaving(true);
    try {
      const quotesCollectionRef = collection(db, `/artifacts/${appId}/users/${userId}/quotes`);
      await addDoc(quotesCollectionRef, {
        type: type, // 'single', 'build', 'comparison'
        components: type === 'build' ? currentBuild : type === 'single' ? [{ name: componentName, analysis: analysisData }] : [{ name: componentA }, { name: componentB }],
        analysis: analysisData,
        createdAt: serverTimestamp(),
      });
      setSaveMessage('¡Cotización guardada exitosamente!');
    } catch (error) {
      console.error("Error al guardar la cotización: ", error);
      setSaveMessage('Error al guardar la cotización. Por favor, revisa la consola para más detalles.');
    } finally {
      setIsSaving(false);
      setTimeout(() => setSaveMessage(""), 5000);
    }
  };

  const handleDeleteQuote = async (id) => {
    if (!db || !userId) return;
    try {
      const docRef = doc(db, `/artifacts/${appId}/users/${userId}/quotes`, id);
      await deleteDoc(docRef);
    } catch (error) {
      console.error("Error al eliminar la cotización: ", error);
    }
  };

  // Functions for multi-component build
  const addComponentField = () => {
    setCurrentBuild([...currentBuild, { name: '', type: 'cpu' }]);
  };

  const removeComponentField = (index) => {
    const newBuild = currentBuild.filter((_, i) => i !== index);
    setCurrentBuild(newBuild);
  };

  const updateComponentField = (index, key, value) => {
    const newBuild = [...currentBuild];
    newBuild[index][key] = value;
    setCurrentBuild(newBuild);
  };

  const handleBuildAnalysis = async () => {
    setIsLoadingBuild(true);
    setBuildError("");
    setBuildAnalysisResult(null);
    setComponentInfo(null);
    setComparisonResult(null);
    const validComponents = currentBuild.filter(comp => comp.name.trim() !== '');
    if (validComponents.length < 2) {
      setBuildError("Por favor, agrega al menos dos componentes para el análisis de la configuración.");
      setIsLoadingBuild(false);
      return;
    }

    try {
      const componentList = validComponents.map(comp => `${comp.type} ${comp.name}`).join(', ');
      // The prompt now requests estimated price and FPS for specific games
      const prompt = `Analiza la compatibilidad y el rendimiento de los siguientes componentes para una PC: ${componentList}. Proporciona el análisis en formato JSON. El objeto JSON debe tener una clave 'conclusion' con un resumen general, una clave 'compatibility' que es un arreglo de objetos (cada objeto con 'component1', 'component2', 'compatibilityStatus' (compatible, incompatible, o advertencia), una 'comment' con una explicación, y dos nuevas claves: 'recommendationStatus' (recomendable, no recomendable, o advertencia) y 'detailedExplanation' explicando por qué es o no recomendable). Si se detecta un cuello de botella o un desequilibrio, añade una clave 'suggestedUpgrade' que sea un objeto con la clave 'componentToChange' y 'recommendedModel'. Finalmente, incluye una clave 'bottlenecks' que es un arreglo de strings con posibles cuellos de botella. Agrega también una clave 'estimatedPrice' con un string del precio total de la configuración en USD y una clave 'estimatedFPS' con un arreglo de objetos que contengan 'game' (ej. "Fortnite", "Warzone") y 'fps' (ej. "60-80 en 1080p"). Si el análisis no es posible, proporciona una clave 'error' con un mensaje.`;
      const payload = {
        contents: [{ role: "user", parts: [{ text: prompt }] }],
        generationConfig: {
          responseMimeType: "application/json",
          responseSchema: {
              type: "OBJECT",
              properties: {
                  conclusion: { type: "STRING" },
                  compatibility: { type: "ARRAY", items: { type: "OBJECT", properties: { component1: { type: "STRING" }, component2: { type: "STRING" }, compatibilityStatus: { type: "STRING" }, comment: { type: "STRING" }, recommendationStatus: { type: "STRING" }, detailedExplanation: { type: "STRING" }, suggestedUpgrade: { type: "OBJECT", properties: { componentToChange: { type: "STRING" }, recommendedModel: { type: "STRING" } } } } } },
                  bottlenecks: { type: "ARRAY", items: { type: "STRING" } },
                  estimatedPrice: { type: "STRING" },
                  estimatedFPS: { type: "ARRAY", items: { type: "OBJECT", properties: { game: { type: "STRING" }, fps: { type: "STRING" } } } },
                  error: { type: "STRING" }
              }
          }
        }
      };
      const apiKey = "";
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
      const response = await fetchWithRetry(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const result = await response.json();
      const generatedJson = result?.candidates?.[0]?.content?.parts?.[0]?.text;

      if (!generatedJson) {
        setBuildError("Ocurrió un error al analizar la configuración. La respuesta del servidor está vacía o es incorrecta.");
        setIsLoadingBuild(false);
        return;
      }

      const parsedData = JSON.parse(generatedJson);

      if (parsedData.error) {
        setBuildError(parsedData.error);
        setIsLoadingBuild(false);
        return;
      }
      setBuildAnalysisResult(parsedData);
    } catch (err) {
      console.error(err);
      setBuildError("Ocurrió un error al analizar la configuración. Por favor, intenta de nuevo.");
    } finally {
      setIsLoadingBuild(false);
    }
  };
  
  const handleCompareComponents = async () => {
    setIsLoadingComparison(true);
    setComparisonError("");
    setComparisonResult(null);
    setComponentInfo(null);
    setBuildAnalysisResult(null);
  
    if (!componentA || !componentB) {
      setComparisonError("Por favor, ingresa los nombres de dos componentes para comparar.");
      setIsLoadingComparison(false);
      return;
    }
  
    try {
      const prompt = `Compara los siguientes dos componentes de computadora: "${componentA}" y "${componentB}". Proporciona el análisis en formato JSON. El objeto JSON debe tener una clave 'comparisonSummary' que es un arreglo de objetos (cada objeto con 'heading' y 'points'), una clave 'detailedComparison' que es un arreglo de objetos (cada objeto con 'feature' (ej. "Rendimiento", "Precio", etc.), 'componentAValue', 'componentBValue' y 'analysis' que explica las diferencias), y una clave 'recommendation' que es un string con una recomendación final. Si no se puede comparar, devuelve un objeto JSON con la clave 'error' y un mensaje descriptivo.`;
      const payload = {
        contents: [{ role: "user", parts: [{ text: prompt }] }],
        generationConfig: {
          responseMimeType: "application/json",
          responseSchema: {
            type: "OBJECT",
            properties: {
              comparisonSummary: { type: "ARRAY", items: { type: "OBJECT", properties: { heading: { type: "STRING" }, points: { type: "ARRAY", items: { type: "STRING" } } } } },
              detailedComparison: { type: "ARRAY", items: { type: "OBJECT", properties: { feature: { type: "STRING" }, componentAValue: { type: "STRING" }, componentBValue: { type: "STRING" }, analysis: { type: "STRING" } } } },
              recommendation: { type: "STRING" },
              error: { type: "STRING" }
            }
          }
        }
      };
      const apiKey = "";
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
      const response = await fetchWithRetry(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
  
      const result = await response.json();
      const generatedJson = result?.candidates?.[0]?.content?.parts?.[0]?.text;
  
      if (!generatedJson) {
        setComparisonError("Ocurrió un error al comparar los componentes. La respuesta del servidor está vacía o es incorrecta.");
        setIsLoadingComparison(false);
        return;
      }
  
      const parsedData = JSON.parse(generatedJson);
  
      if (parsedData.error) {
        setComparisonError(parsedData.error);
        setIsLoadingComparison(false);
        return;
      }
      setComparisonResult(parsedData);
    } catch (err) {
      console.error(err);
      setComparisonError("Ocurrió un error al comparar los componentes. Por favor, intenta de nuevo.");
    } finally {
      setIsLoadingComparison(false);
    }
  };

  const getRecommendationStyle = (status) => {
    switch(status?.toLowerCase()) {
      case 'recomendable':
        return { color: 'text-green-400', icon: <CheckCircleIcon className="h-5 w-5"/>, label: 'Recomendable' };
      case 'no recomendable':
        return { color: 'text-red-400', icon: <XCircleIcon className="h-5 w-5"/>, label: 'No Recomendable' };
      case 'advertencia':
        return { color: 'text-yellow-400', icon: <AlertCircleIcon className="h-5 w-5"/>, label: 'Advertencia' };
      default:
        return { color: 'text-gray-400', icon: null, label: 'Desconocido' };
    }
  };

  // Logic for filtering and sorting quotes
  const filteredAndSortedQuotes = quotes
    .filter(quote =>
      (quote.components && quote.components.some(comp => comp.name.toLowerCase().includes(searchTerm.toLowerCase()))) ||
      (quote.type === 'build' && 'configuración de pc'.includes(searchTerm.toLowerCase())) ||
      (quote.type === 'comparison' && 'comparación de componentes'.includes(searchTerm.toLowerCase()))
    )
    .sort((a, b) => {
      const dateA = a.createdAt?.toDate() || new Date(0);
      const dateB = b.createdAt?.toDate() || new Date(0);
      if (sortBy === 'dateAsc') return dateA - dateB;
      if (sortBy === 'dateDesc') return dateB - dateA;
      if (sortBy === 'typeAsc') return a.type.localeCompare(b.type);
      if (sortBy === 'typeDesc') return b.type.localeCompare(a.type);
      return 0;
    });

  return (
    <div className="flex flex-col items-center justify-start p-8 bg-gray-900 text-white min-h-screen font-inter">
      {userId && (
        <div className="flex items-center space-x-2 text-sm text-gray-500 mb-8 p-3 bg-gray-800 rounded-lg">
          <UserIcon />
          <span>ID de usuario:</span>
          <span className="font-mono text-xs">{userId}</span>
        </div>
      )}

      {saveMessage && (
        <div className={`fixed top-4 left-1/2 -translate-x-1/2 p-4 rounded-xl shadow-lg transition-all duration-300 ${saveMessage.includes('exitosamente') ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}`}>
          <p className="text-sm font-semibold">{saveMessage}</p>
        </div>
      )}

      {/* Sección de análisis de un solo componente */}
      <div className="w-full max-w-4xl bg-gray-800 rounded-2xl shadow-xl p-8 mb-8">
        <h1 className="text-4xl font-bold mb-4 text-center text-amber-400">Analizador de Componentes</h1>
        <p className="text-gray-400 mb-8 text-center">
          Ingresa el nombre de un procesador (CPU), tarjeta gráfica (GPU), un monitor o auriculares.
        </p>
        <div className="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4 mb-8">
          <input
            type="text"
            className="flex-grow w-full px-4 py-3 rounded-xl bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-amber-500 transition-all"
            placeholder="Ej: Ryzen 5 7600X, RTX 4070, monitor 27"
            value={componentName}
            onChange={(e) => setComponentName(e.target.value)}
            onKeyDown={(e) => { if (e.key === 'Enter') handleAnalyze(); }}
          />
          <button
            onClick={handleAnalyze}
            disabled={isLoading}
            className="w-full sm:w-auto px-6 py-3 bg-amber-500 hover:bg-amber-600 text-gray-900 font-bold rounded-xl shadow-lg transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2"
          >
            {isLoading ? (
              <svg className="animate-spin h-5 w-5 text-gray-900" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            ) : (
              <>
                <CpuIcon className="h-5 w-5" />
                <span>Analizar</span>
              </>
            )}
          </button>
        </div>
        {error && (
          <div className="bg-red-900 text-red-300 p-4 rounded-xl text-center mb-8"><p>{error}</p></div>
        )}
        {componentInfo?.summary?.length > 0 && (
          <div className="bg-gray-700 p-6 rounded-2xl shadow-inner animate-fade-in">
            <div className="flex justify-between items-start">
              <div>
                <h2 className="text-3xl font-bold text-amber-400 capitalize mb-2">
                  {isGeneralAnalysis ? `Análisis General para "${componentName}"` : componentName}
                </h2>
                <div className="flex items-center space-x-2 mb-6">
                  {!isGeneralAnalysis && (
                    <>
                      <span className="text-sm font-semibold text-gray-400">Gama:</span>
                      <span className="px-3 py-1 bg-amber-500 text-gray-900 rounded-full text-xs font-bold capitalize">{componentInfo.gama}</span>
                      {componentInfo.releaseYear && (
                        <>
                          <span className="text-sm font-semibold text-gray-400 ml-4">Año:</span>
                          <span className="px-3 py-1 bg-amber-500 text-gray-900 rounded-full text-xs font-bold">{componentInfo.releaseYear}</span>
                        </>
                      )}
                    </>
                  )}
                </div>
              </div>
              <button
                onClick={() => handleSaveQuote(componentInfo, 'single')}
                disabled={isSaving}
                className="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-xl shadow-lg transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-2"
              >
                {isSaving ? (
                  <svg className="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                ) : (
                  <>
                    <PlusIcon className="h-4 w-4" />
                    <span>Guardar Cotización</span>
                  </>
                )}
              </button>
            </div>
            <div className="space-y-4">
              {componentInfo.summary.map((section, index) => (
                <div key={index} className="bg-gray-800 p-4 rounded-xl shadow-inner">
                  <h3 className="text-xl font-semibold mb-2 text-amber-300">{section.heading}</h3>
                  <ul className="list-disc list-inside space-y-1 text-gray-300 text-sm">
                    {section.points.map((point, pointIndex) => (
                      <li key={pointIndex}>{point}</li>
                    ))}
                  </ul>
                </div>
              ))}
              {componentInfo.recommendations?.length > 0 && (
                <div className="bg-gray-800 p-4 rounded-xl shadow-inner">
                  <h3 className="text-xl font-semibold mb-2 text-amber-300">Componentes Recomendados</h3>
                  <ul className="list-disc list-inside space-y-1 text-gray-300 text-sm">
                    {componentInfo.recommendations.map((rec, index) => (
                      <li key={index}><strong>{rec.component}:</strong> {rec.model}</li>
                    ))}
                  </ul>
                </div>
              )}
            </div>
          </div>
        )}
      </div>
      
      <hr className="w-full max-w-4xl border-gray-700 my-8"/>
      
      {/* Sección de comparación de dos componentes */}
      <div className="w-full max-w-4xl bg-gray-800 rounded-2xl shadow-xl p-8 mb-8">
        <h2 className="text-4xl font-bold mb-4 text-center text-blue-400">Comparador de Componentes</h2>
        <p className="text-gray-400 mb-6 text-center">
          Compara dos componentes (CPU, GPU o monitores) para ver sus diferencias.
        </p>
        <div className="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4 mb-6">
          <input
            type="text"
            className="flex-grow w-full px-4 py-3 rounded-xl bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
            placeholder="Primer componente (Ej: i5-11400F)"
            value={componentA}
            onChange={(e) => setComponentA(e.target.value)}
          />
          <span className="text-lg font-bold text-gray-400">vs</span>
          <input
            type="text"
            className="flex-grow w-full px-4 py-3 rounded-xl bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
            placeholder="Segundo componente (Ej: i5-10400)"
            value={componentB}
            onChange={(e) => setComponentB(e.target.value)}
          />
          <button
            onClick={handleCompareComponents}
            disabled={isLoadingComparison}
            className="w-full sm:w-auto px-6 py-3 bg-blue-500 hover:bg-blue-600 text-gray-900 font-bold rounded-xl shadow-lg transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2"
          >
            {isLoadingComparison ? (
              <svg className="animate-spin h-5 w-5 text-gray-900" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            ) : (
              <>
                <CompareArrowsIcon className="h-5 w-5" />
                <span>Comparar</span>
              </>
            )}
          </button>
        </div>
        {comparisonError && (
          <div className="bg-red-900 text-red-300 p-4 rounded-xl text-center mb-8"><p>{comparisonError}</p></div>
        )}
        {comparisonResult && (
          <div className="bg-gray-700 p-6 rounded-2xl shadow-inner animate-fade-in">
            <h3 className="text-3xl font-bold mb-4 text-blue-400 text-center">Resultados de la Comparación</h3>
            <div className="flex justify-between items-center mb-4">
              <h4 className="text-xl font-bold text-blue-300">{componentA}</h4>
              <h4 className="text-xl font-bold text-blue-300">{componentB}</h4>
            </div>
            
            <div className="space-y-4">
              {comparisonResult.detailedComparison.map((comp, index) => (
                <div key={index} className="p-4 rounded-xl bg-gray-800 border border-gray-600">
                  <h5 className="text-lg font-semibold text-white mb-2">{comp.feature}</h5>
                  <div className="grid grid-cols-2 gap-4 text-sm">
                    <div className="text-gray-300">
                      <strong>{componentA}:</strong> {comp.componentAValue}
                    </div>
                    <div className="text-gray-300">
                      <strong>{componentB}:</strong> {comp.componentBValue}
                    </div>
                  </div>
                  <p className="text-xs text-gray-400 mt-2">
                    <strong>Análisis:</strong> {comp.analysis}
                  </p>
                </div>
              ))}
            </div>

            <div className="mt-6 p-4 rounded-xl bg-gray-800 border border-gray-600">
              <h4 className="text-xl font-semibold mb-2 text-blue-300">Recomendación Final</h4>
              <p className="text-gray-300">{comparisonResult.recommendation}</p>
            </div>
            
            <button
              onClick={() => handleSaveQuote(comparisonResult, 'comparison')}
              disabled={isSaving}
              className="mt-4 w-full px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-xl shadow-lg transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2"
            >
              {isSaving ? (
                <svg className="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
              ) : (
                <>
                  <PlusIcon className="h-4 w-4" />
                  <span>Guardar Comparación</span>
                </>
              )}
            </button>
          </div>
        )}
      </div>

      <hr className="w-full max-w-4xl border-gray-700 my-8"/>

      {/* Sección de construcción y comparación de PC (multi-componente) */}
      <div className="w-full max-w-4xl bg-gray-800 rounded-2xl shadow-xl p-8 mb-8">
        <h2 className="text-4xl font-bold mb-4 text-center text-green-400">Constructor y Comparador de PC</h2>
        <p className="text-gray-400 mb-6 text-center">
          Arma tu PC, compara componentes, y verifica la compatibilidad, el precio y el rendimiento (FPS).
        </p>

        <div className="space-y-4 mb-6">
          {currentBuild.map((comp, index) => (
            <div key={index} className="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-2">
              <select
                className="w-full sm:w-1/4 px-4 py-3 rounded-xl bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-green-500 transition-all"
                value={comp.type}
                onChange={(e) => updateComponentField(index, 'type', e.target.value)}
              >
                <option value="cpu">CPU</option>
                <option value="gpu">GPU</option>
                <option value="motherboard">Placa Madre</option>
                <option value="ram">RAM</option>
                <option value="storage">Almacenamiento</option>
                <option value="psu">PSU</option>
                <option value="monitor">Monitor</option>
              </select>
              <input
                type="text"
                className="flex-grow w-full px-4 py-3 rounded-xl bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500 transition-all"
                placeholder={`Nombre del componente ${index + 1}`}
                value={comp.name}
                onChange={(e) => updateComponentField(index, 'name', e.target.value)}
              />
              <button
                onClick={() => removeComponentField(index)}
                className="p-3 bg-red-600 hover:bg-red-700 text-white rounded-xl shadow-lg transition-all transform hover:scale-105"
                aria-label="Eliminar componente"
              >
                <Trash2Icon className="h-5 w-5" />
              </button>
            </div>
          ))}
        </div>
        <div className="flex justify-between items-center mb-6">
          <button
            onClick={addComponentField}
            className="px-6 py-3 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-xl shadow-lg transition-all transform hover:scale-105 flex items-center space-x-2"
          >
            <PlusIcon className="h-5 w-5" />
            <span>Añadir Componente</span>
          </button>
          <button
            onClick={handleBuildAnalysis}
            disabled={isLoadingBuild}
            className="px-6 py-3 bg-green-500 hover:bg-green-600 text-gray-900 font-bold rounded-xl shadow-lg transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2"
          >
            {isLoadingBuild ? (
              <svg className="animate-spin h-5 w-5 text-gray-900" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            ) : (
              <>
                <SettingsIcon className="h-5 w-5" />
                <span>Analizar Configuración</span>
              </>
            )}
          </button>
        </div>
        {buildError && (
          <div className="bg-red-900 text-red-300 p-4 rounded-xl text-center mb-8"><p>{buildError}</p></div>
        )}
        {buildAnalysisResult && (
          <div className="bg-gray-700 p-6 rounded-2xl shadow-inner animate-fade-in">
            <h3 className="text-3xl font-bold mb-4 text-green-400">Análisis de Configuración</h3>
            
            {/* Sección de Precio Estimado */}
            {buildAnalysisResult.estimatedPrice && (
              <div className="mb-4 p-4 rounded-xl bg-gray-800 border-l-4 border-green-500 flex items-center space-x-3">
                <DollarSignIcon className="h-8 w-8 text-green-400" />
                <div>
                  <h4 className="text-xl font-semibold text-green-300">Precio Estimado</h4>
                  <p className="text-white text-lg font-bold">{buildAnalysisResult.estimatedPrice}</p>
                </div>
              </div>
            )}

            {/* Sección de FPS Estimados */}
            {buildAnalysisResult.estimatedFPS?.length > 0 && (
              <div className="mb-4 p-4 rounded-xl bg-gray-800 border-l-4 border-cyan-500">
                <div className="flex items-center space-x-3 mb-2">
                  <GaugeIcon className="h-8 w-8 text-cyan-400" />
                  <h4 className="text-xl font-semibold text-cyan-300">Rendimiento (FPS Estimados)</h4>
                </div>
                <ul className="list-disc list-inside space-y-1 text-gray-300 text-sm ml-6">
                  {buildAnalysisResult.estimatedFPS.map((item, index) => (
                    <li key={index}>
                      <strong>{item.game}:</strong> {item.fps}
                    </li>
                  ))}
                </ul>
              </div>
            )}

            {/* Sección de Conclusión */}
            <div className="mb-4">
              <h4 className="text-xl font-semibold mb-2 text-green-300">Conclusión General</h4>
              <p className="text-gray-300">{buildAnalysisResult.conclusion}</p>
            </div>
            {buildAnalysisResult.compatibility?.length > 0 && (
              <div className="mb-4">
                <h4 className="text-xl font-semibold mb-2 text-green-300">Análisis de Compatibilidad y Recomendación</h4>
                <div className="space-y-4">
                  {buildAnalysisResult.compatibility.map((comp, index) => {
                    const recommendation = getRecommendationStyle(comp.recommendationStatus);
                    return (
                      <div key={index} className="p-4 rounded-xl bg-gray-800 border border-gray-600">
                        <div className="flex items-center space-x-2 mb-2">
                          <p className="text-sm font-semibold text-white">
                            <strong className="text-white">{comp.component1}</strong> y <strong className="text-white">{comp.component2}</strong>
                          </p>
                          <div className={`flex items-center space-x-1 p-1 px-2 rounded-full text-xs font-bold ${recommendation.color} ${recommendation.color === 'text-green-400' ? 'bg-green-900/50' : recommendation.color === 'text-yellow-400' ? 'bg-yellow-900/50' : 'bg-red-900/50'}`}>
                            {recommendation.icon}
                            <span>{recommendation.label}</span>
                          </div>
                        </div>
                        <p className="text-xs text-gray-400 mt-1">
                          <strong className="text-gray-300">Estado de Compatibilidad:</strong> {comp.compatibilityStatus}. {comp.comment}
                        </p>
                        {comp.detailedExplanation && (
                          <p className="text-xs text-gray-300 mt-2">
                            <strong className="text-gray-200">Recomendación:</strong> {comp.detailedExplanation}
                          </p>
                        )}
                        {comp.suggestedUpgrade && (
                          <div className="mt-4 p-3 bg-yellow-900/30 border border-yellow-700 rounded-lg flex items-center space-x-2 animate-pulse-once">
                            <ArrowUpCircleIcon className="h-6 w-6 text-yellow-300 flex-shrink-0" />
                            <p className="text-sm text-yellow-300">
                              <strong className="font-semibold">Sugerencia de Mejora:</strong> Para un mejor rendimiento, considera cambiar el **{comp.suggestedUpgrade.componentToChange}** por el modelo **{comp.suggestedUpgrade.recommendedModel}**.
                            </p>
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              </div>
            )}
            {buildAnalysisResult.bottlenecks?.length > 0 && (
              <div className="mb-4">
                <h4 className="text-xl font-semibold mb-2 text-green-300">Posibles Cuellos de Botella</h4>
                <ul className="list-disc list-inside space-y-1 text-gray-300 text-sm">
                  {buildAnalysisResult.bottlenecks.map((bottleneck, index) => (
                    <li key={index}>{bottleneck}</li>
                  ))}
                </ul>
              </div>
            )}
            <button
              onClick={() => handleSaveQuote(buildAnalysisResult, 'build')}
              disabled={isSaving}
              className="mt-4 w-full px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-xl shadow-lg transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2"
            >
              {isSaving ? (
                <svg className="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
              ) : (
                <>
                  <PlusIcon className="h-4 w-4" />
                  <span>Guardar Configuración</span>
                </>
              )}
            </button>
          </div>
        )}
      </div>

      <hr className="w-full max-w-4xl border-gray-700 my-8"/>

      {/* Historial de Cotizaciones */}
      <div className="w-full max-w-4xl bg-gray-800 rounded-2xl shadow-xl p-8">
        <h2 className="text-4xl font-bold mb-6 text-center text-blue-400">Historial de Cotizaciones</h2>
        <div className="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4 mb-6">
          <div className="relative w-full">
            <input
              type="text"
              className="w-full px-4 py-3 pl-12 rounded-xl bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
              placeholder="Buscar por nombre de componente o tipo..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
            />
            <SearchIcon className="absolute left-4 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" />
          </div>
          <select
            value={sortBy}
            onChange={(e) => setSortBy(e.target.value)}
            className="w-full sm:w-auto px-4 py-3 rounded-xl bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
          >
            <option value="dateDesc">Fecha (Más Reciente)</option>
            <option value="dateAsc">Fecha (Más Antigua)</option>
            <option value="typeAsc">Tipo (A-Z)</option>
            <option value="typeDesc">Tipo (Z-A)</option>
          </select>
        </div>
        {filteredAndSortedQuotes.length > 0 ? (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {filteredAndSortedQuotes.map((quote) => (
              <div key={quote.id} className="bg-gray-700 p-4 rounded-xl shadow-inner flex flex-col space-y-2">
                <div className="flex items-center justify-between text-blue-300">
                  <div className="flex items-center space-x-2 truncate">
                    <FileTextIcon className="w-5 h-5"/>
                    {quote.type === 'build' ? (
                      <h4 className="text-lg font-bold">Configuración de PC</h4>
                    ) : quote.type === 'single' ? (
                      <h4 className="text-lg font-bold truncate">{quote.components[0]?.name}</h4>
                    ) : (
                      <h4 className="text-lg font-bold">Comparación</h4>
                    )}
                  </div>
                  <button
                    onClick={() => handleDeleteQuote(quote.id)}
                    className="p-1 text-red-400 hover:text-red-500 transition-colors"
                    aria-label="Eliminar cotización"
                  >
                    <Trash2Icon className="h-5 w-5" />
                  </button>
                </div>
                <div className="text-xs text-gray-400">
                  {quote.createdAt && <p>Guardado el {new Date(quote.createdAt.toDate()).toLocaleDateString()}</p>}
                  {quote.type === 'single' && (
                    <p className="capitalize">Gama: <span className="font-semibold">{quote.analysis.gama}</span></p>
                  )}
                  {quote.type === 'build' && (
                    <p className="capitalize">Componentes: <span className="font-semibold">{quote.components.length}</span></p>
                  )}
                </div>
                <button
                  onClick={() => {
                    // Resetting states before showing details
                    setComponentInfo(null);
                    setBuildAnalysisResult(null);
                    setComparisonResult(null);
                    setComponentName("");

                    if (quote.type === 'single') {
                      setComponentName(quote.components[0].name);
                      setComponentInfo(quote.analysis);
                    } else if (quote.type === 'build') {
                      setCurrentBuild(quote.components);
                      setBuildAnalysisResult(quote.analysis);
                    } else if (quote.type === 'comparison') {
                      setComponentA(quote.components[0].name);
                      setComponentB(quote.components[1].name);
                      setComparisonResult(quote.analysis);
                    }
                  }}
                  className="mt-2 px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white text-xs rounded-lg transition-colors"
                >
                  Ver Detalles
                </button>
              </div>
            ))}
          </div>
        ) : (
          <div className="text-center text-gray-500">
            <p>Todavía no has guardado ninguna cotización.</p>
            <p>Analiza un componente o crea una configuración para empezar.</p>
          </div>
        )}
      </div>
    </div>
  );
}

export default App;

